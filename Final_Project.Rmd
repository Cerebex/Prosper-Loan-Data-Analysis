---
title: "Sam Miller's Loan Data from Prosper Exploration"
output: html_document
---
This data set contains 113,937 loans with 81 variables on each loan, including 
loan amount, borrower rate (or interest rate), current loan status, 
borrower income, borrower employment status, borrower credit history, 
and the latest payment information.

I truly wanted to understand in my analysis which party benefits most in which
situations from prosper loans: Prosper, Investor or Borrower? How easy is it
for an investor to loose all there money on a prosper loan? What loans
are the most likely to make an investor a large return? I also want to
understand how specific credit ratings and scores relate to borrowers 
characteristics. I hope I can provide you with some interesting insights 
into the world of prosper loans by the end of this analysis.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,message=FALSE, warning=FALSE)
```

```{r, include = FALSE}
setwd(paste("/Users/samm/Documents/GitHub/Prosper-Loan-Data-Analysis", sep=""))

library(ggplot2) #must load the ggplot package first
library(dplyr)
library(tidyr)
library(knitr)
library(lubridate)
library(gridExtra)
library(pander)
```

```{r}
Loans <- read.csv('prosperLoanData.csv', header = T, check.names = F, 
                  na.strings=c(""," ","NA"))
```

## Analysis and Exploration of the Data

###Univariate Plots

Size of Data set and Data Types

```{r Classes}
str(Loans)
```

Summary Statistics of Data

```{r}
pander(summary(Loans))
```


Credit Grades before 2009 are missing for many loans but for those that do exist 
a C credit rating is most prevalent. I wonder why C credit grades borrowers are 
granted the most loans. 

```{r}
ggplot(Loans, aes(CreditGrade))+
  geom_bar()+
  scale_y_log10()
```


Lower Credit Scores are mostly between 360 and 880. Some people have 0 for 
their lower credit score since if you have a credit score lower than 350 it 
is automatically set to zero. If you remove these 0 credit scores you are able 
to see weird areas around credit score 600-620 and 780-800 that do not 
have any scores. I do not understand these empty spaces but overall the
distribution is normal. 

```{r}
grid.arrange(ggplot(subset(Loans, !is.na(CreditScoreRangeLower)), 
       aes(x = "CreditScoreRangeLower", y=CreditScoreRangeLower))+
  geom_boxplot()+
  labs(list(title = "CreditScoreRangeLower No NA",
            x = "CreditScoreRangeLower No NA"))+
  theme(plot.title = element_text(size=10)),
  ggplot(subset(Loans, !is.na(CreditScoreRangeLower)), 
       aes(x = CreditScoreRangeLower, y=..count..))+
  geom_histogram()+
  labs(list(title = "CreditScoreRangeLower No NA",
            x = "CreditScoreRangeLower No NA"))+
  theme(plot.title = element_text(size=10)),
  ggplot(subset(Loans, !is.na(CreditScoreRangeLower)&
                  CreditScoreRangeLower!=0), 
       aes(x = CreditScoreRangeLower, y=..count..))+
  geom_histogram()+
  labs(list(title = "CreditScoreRangeLower No NA&0",
            x = "CreditScoreRangeLower No NA&0"))+
  theme(plot.title = element_text(size=10)), ncol=3)
```

There are a few outlier upper credit scores of 19 but if these are removed the 
overall plot is normal with small holes around around credit score 600-620 
and 780-800 just like in the lower credit scores.  

```{r}
grid.arrange(
  ggplot(subset(Loans, !is.na(CreditScoreRangeUpper)), 
       aes(x = "CreditScoreRangeUpper", y=CreditScoreRangeUpper))+
  geom_boxplot()+
  labs(list(title = "CreditScoreRangeUpper No NA",
            x = "CreditScoreRangeUpper No NA"))+
  theme(plot.title = element_text(size=10)),
  ggplot(subset(Loans, !is.na(CreditScoreRangeUpper)), 
       aes(x = CreditScoreRangeUpper, y=..count..))+
  geom_histogram()+
  labs(list(title = "CreditScoreRangeUpper No NA",
            x = "CreditScoreRangeUpper No NA"))+
  theme(plot.title = element_text(size=10)),
  ggplot(subset(Loans, !is.na(CreditScoreRangeUpper)&
                  CreditScoreRangeUpper!=19), 
       aes(x = CreditScoreRangeUpper, y=..count..))+
  geom_histogram()+
  labs(list(title = "CreditScoreRangeUpper No NA&19",
            x = "CreditScoreRangeUpper No NA&0"))+
  theme(plot.title = element_text(size=10)),ncol=3)
```


36 months is the most prevalent loan term length. I wonder why a 36 month loan
is most prevalent. 

```{r}
Loans_Terms <- Loans %>%
                group_by(Term) %>%
                summarise(Total_Count = n())

ggplot(Loans_Terms, aes(x= Term, y = Total_Count, label = Total_Count ))+
  geom_bar(stat="identity")+
  scale_x_continuous(breaks= c(12,36,60))+
  geom_text(vjust = -.5)
```

While there are many defaulted or charged off loans, most loans are current
or completed.

```{r}
ggplot(Loans, aes(LoanStatus))+
  geom_bar()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1,size=6))+
  coord_flip()
```

Estimated Returns seems to have normal distribution centered around .1 with 
some outliers that go into the negative returns.

```{r}
grid.arrange( 
  ggplot(subset(Loans, !is.na(EstimatedReturn)), 
       aes(x = "EstimatedReturn", y=EstimatedReturn))+
  geom_boxplot()+
  labs(list(title = "EstimatedReturn No NA",
            x = "EstimatedReturn No NA"))+
  theme(plot.title = element_text(size=20)),
  ggplot(subset(Loans, !is.na(EstimatedReturn)), 
       aes(x = EstimatedReturn, y=..count..))+
  geom_histogram()+
  labs(list(title = "EstimatedReturn No NA",
            x = "EstimatedReturn No NA"))+
  theme(plot.title = element_text(size=20)),ncol=2)

summary(Loans$EstimatedReturn)
```

Most borrowers for prosper loans reside in California. It seems that the states
with the largest cities seem the have the largest density of borrowers.

```{r}
names(Loans) <- sub(" ", ".", names(Loans))

CreditGrades <- Loans%>%
  select(ListingKey, CreditGrade, ProsperRating.Alpha)

CreditGrades$CreditGrade[is.na(CreditGrades$CreditGrade)] <- CreditGrades$ProsperRating.Alpha[is.na(CreditGrades$CreditGrade)]

Loans$AllCreditGrades <- CreditGrades$CreditGrade
Loans$AllCreditGrades <- factor(Loans$AllCreditGrades, levels = c('AA','A','B', 
                                                                  'C', 'D', 
                                                                  "E", "HR",
                                                                  "NC"))

Estimated_Total_Returnincash <- Loans %>%
  mutate(Total_Estimated_Return_Cash = EstimatedReturn*LoanOriginalAmount)
```

```{r}
state_count <- Loans %>%
  select(BorrowerState)%>%
  group_by(BorrowerState)%>%
  summarise(count = n())%>%
  arrange(count)

state_count$BorrowerState <- factor(state_count$BorrowerState, levels =
                          state_count$BorrowerState[order(state_count$count)])

ggplot(subset(state_count, !is.na(BorrowerState)), 
       aes(x = BorrowerState,y=count))+
  geom_bar(stat="identity")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1,size=10))+
  coord_flip()
```

Most borrowers have a debt to income around .22 but the distribution is
positively skewed with many large outliers. For example, some have a D2I ratio 
of 10.01:1. I wonder which type of borrower takes on such a large debt to
income ratio?

```{r}
grid.arrange(
    ggplot(subset(Loans, !is.na(DebtToIncomeRatio)), aes(x = "All D2I", 
                                                  y = DebtToIncomeRatio))+
  geom_boxplot(size=1),
  ggplot(subset(Loans, !is.na(DebtToIncomeRatio)), 
         aes(x = "Remove D2I Outliers", y = DebtToIncomeRatio))+
  geom_boxplot(size=1)+
  coord_cartesian(ylim=c(0, .6)), 
  ggplot(subset(Loans, !is.na(DebtToIncomeRatio)), aes(DebtToIncomeRatio))+
  geom_histogram(binwidth = .01)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1,size=8))+
  scale_x_continuous(breaks= seq(0,2,.1))+
      coord_cartesian(xlim=c(0,1)),ncol=3)

summary(subset(Loans, !is.na(DebtToIncomeRatio))$DebtToIncomeRatio)  
```

Most prosper borrowers have an income in the range of $25,000-$49,999.

```{r}
ggplot(subset(Loans, !is.na(IncomeRange), !is.na(IncomeRange)), 
       aes(x = IncomeRange))+
  geom_bar()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1,size=8))
```

Most prosper borrowers are making around $4000 a month which falls right in 
line with a yearly income of about $48,000. At the same time one borrower had 
a stated monthly income of $1,750,000. Could this outlier be an error since 
this person would potentially be making over $21,000,000 a year need a loan
for $4000?

```{r}
grid.arrange(
  ggplot(subset(Loans, !is.na(StatedMonthlyIncome)), 
       aes(x = "All Monthly Income Data", y = StatedMonthlyIncome))+
  geom_boxplot(),
    ggplot(subset(Loans, !is.na(StatedMonthlyIncome)), 
       aes(x = "Zoomed Monthly Income Data", y = StatedMonthlyIncome))+
  geom_boxplot()+
    coord_cartesian(ylim=c(0,12000)),
  ggplot(subset(Loans, !is.na(StatedMonthlyIncome)), 
       aes(x = StatedMonthlyIncome))+
  geom_histogram(binwidth = 700)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1,size=5))+
  scale_x_continuous(breaks= seq(0,12500,1000))+
  coord_cartesian(xlim =  c(0,12500)),
  ncol =3)

summary(subset(Loans, !is.na(StatedMonthlyIncome))$StatedMonthlyIncome)  

Loans %>% 
  filter(StatedMonthlyIncome>1750000)%>%
  select(LoanOriginalAmount)
```

There seems to be spikes in specific loan amounts which may stem from the way
prosper creates loans. Also the distribution for prosper loans seems to be 
positively skewed with a media of $6500 and a maximum of $35000. 

```{r}
grid.arrange(ggplot(subset(Loans, !is.na(LoanOriginalAmount)), 
       aes(x = "All Loan Amount Data", y=LoanOriginalAmount))+
  geom_boxplot(),
  ggplot(subset(Loans, !is.na(LoanOriginalAmount)), 
       aes(LoanOriginalAmount))+
  geom_histogram(binwidth = 100)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1,size=8)),
    ggplot(subset(Loans, !is.na(LoanOriginalAmount)), 
       aes(LoanOriginalAmount))+
  geom_histogram(binwidth = 2000)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1,size=8)),ncol=3)
  
summary(subset(Loans, !is.na(LoanOriginalAmount))$LoanOriginalAmount)
```

Closed Dates do not seem to have any outliers but it has a large dip in
the amount of closed loans in 2012. I wonder why that is.

```{r}
Loans <- mutate(Loans, ClosedDate = as.Date(ClosedDate, format = "%Y-%m-%d"))
grid.arrange(ggplot(subset(Loans, !is.na(ClosedDate)), 
       aes(x = "ClosedDates", y=ClosedDate))+
  geom_boxplot(),
  ggplot(subset(Loans, !is.na(ClosedDate)), 
       aes(ClosedDate))+
  geom_histogram(binwidth = 40)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1,size=8)), ncol = 2)

summary(subset(Loans, !is.na(ClosedDate))$ClosedDate)

```

Borrower APR does not have many outliers with a median APR of .2098. The
distribution seems to be normal with limited spikes at .3 and .38. 

```{r}
grid.arrange(ggplot(subset(Loans, !is.na(BorrowerAPR)), 
       aes(x = "BorrowerAPR", y=BorrowerAPR))+
  geom_boxplot(),
  ggplot(subset(Loans, !is.na(BorrowerAPR)), 
       aes(BorrowerAPR))+
  geom_histogram()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1,size=8)), ncol = 2)

summary(subset(Loans, !is.na(BorrowerAPR))$BorrowerAPR)
```

Most borrowers are listed under debt consolidation.

```{r}
grid.arrange(ggplot(subset(Loans, !is.na(ListingCategory.numeric)), 
       aes(x = "List.Category.Numeric", y=ListingCategory.numeric))+
  geom_boxplot()+
    scale_y_continuous(breaks= seq(0,20,1)),
  ggplot(subset(Loans, !is.na(ListingCategory.numeric)), 
       aes(ListingCategory.numeric))+
  geom_histogram(binwidth=1)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1,size=8)), ncol = 2)

table(subset(Loans, !is.na(ListingCategory.numeric))
            $ListingCategory.numeric)
```

Almost all borrowers have no recommendations when they get a loan from
prosper loans which is staggering. Even when you remove all those with
no recommendations you still have a majority with only 1 recommendation. It 
seems most people who get loans on prosper loans do not have many people 
who think highly of them or having recommendations is not very important
to lenders.

```{r}
grid.arrange(ggplot(subset(Loans, !is.na(Recommendations)), 
       aes(x = "Recommendations", y=Recommendations))+
  geom_boxplot()+
    scale_y_continuous(breaks= seq(0,40,2)),
  ggplot(subset(Loans, !is.na(Recommendations)), 
       aes(Recommendations))+
  geom_histogram(binwidth=1)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1,size=8)),
  ggplot(subset(Loans, !is.na(Recommendations)&Recommendations!=0), 
       aes(x = "Recommendations", y=Recommendations))+
  geom_boxplot()+
    scale_y_continuous(breaks= seq(0,40,2)),
  ggplot(subset(Loans, !is.na(Recommendations)&Recommendations!=0), 
       aes(Recommendations))+
  geom_histogram(binwidth=1)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1,size=8)),ncol = 2)

summary(subset(Loans, !is.na(Recommendations))
            $Recommendations)
table(subset(Loans, !is.na(Recommendations))
            $Recommendations)
```

The current credit lines distribution is very smooth with a slight
positive skew since there are quiet a few large upper outliers. The median is 
10 current credit lines.

```{r}
grid.arrange(ggplot(subset(Loans, !is.na(CurrentCreditLines)), 
       aes(x = "CurrentCreditLines", y=CurrentCreditLines))+
  geom_boxplot(),
  ggplot(subset(Loans, !is.na(CurrentCreditLines)), 
       aes(CurrentCreditLines))+
  geom_histogram(binwidth=1)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1,size=8)),
  ncol = 2)

summary(subset(Loans, !is.na(CurrentCreditLines))
            $CurrentCreditLines)
```

Almost all borrowers are full-time or employed. It seems having a steady job
is very important to prove to lenders that you will pay off your loans.

```{r}
ggplot(subset(Loans, !is.na(EmploymentStatus)), 
       aes(EmploymentStatus))+
geom_bar()

summary(subset(Loans, !is.na(EmploymentStatus))
            $EmploymentStatus)
```

The investment from friends seems to be very positively skewed. The 
distribution is easier to see if it is placed on a a log scale.

```{r}
grid.arrange(ggplot(subset(Loans, !is.na(InvestmentFromFriendsAmount)), 
       aes(x = InvestmentFromFriendsAmount, y=..count..))+
  geom_histogram(binwidth = 800)+
  labs(list(title = "InvestmentFromFriendsAmount No NA",
            x = "InvestmentFromFriends No NA"))+
  theme(plot.title = element_text(size=10)),
  ggplot(subset(Loans, !is.na(InvestmentFromFriendsAmount)&
                  InvestmentFromFriendsAmount!=0), 
       aes(x = InvestmentFromFriendsAmount, y=..count..))+
  geom_histogram(binwidth = 800)+
  labs(list(title = "InvestmentFromFriendsAmount No NA&0",
            x = "InvestmentFromFriends No NA&0"))+
  theme(plot.title = element_text(size=10)),
  ggplot(subset(Loans, !is.na(InvestmentFromFriendsAmount)&
                  InvestmentFromFriendsAmount!=0), 
       aes(x = InvestmentFromFriendsAmount, y=..count..))+
  geom_histogram()+
  scale_x_log10()+
  labs(list(title = "InvestmentFromFriendsAmount No NA&0 LogX",
            x = "InvestmentFromFriends No NA&0 Logx"))+
  theme(plot.title = element_text(size=8)),ncol=3)
```


###Bivariate Plots

Leading up to the 2008 financial crisis there seemed to be a large increase in
defaulted loans. Those loans seemed to convert over to charged off loans after 
2008 and these defaulted loans then increased in number up to around 2009
where they slowly decreased in amount as completed loans greatly increased
on number. It seems the drastic decrease in completed loans lead to 
the large overall decrease in number of closed loans in 2012. After this there 
is an increase in charged of and completed loans up to the present. 

```{r}
ggplot(subset(Loans, !is.na(ClosedDate)), 
       aes(ClosedDate, fill = LoanStatus))+
  geom_histogram(binwidth = 100, position = "dodge")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1,size=8))
```


Most of the largely correlated items in the correlation matrix are interrelated
and do not shed large insights into relationships in the data alone.

```{r}
library("GGally")
Loans_Numeric <- Loans[,sapply(Loans, is.numeric)]

drops <- c("ListingNumber","LoanNumber")
Loans_Numeric <-Loans_Numeric[ , !(names(Loans_Numeric) %in% drops)]

ggcorr(Loans_Numeric, label = TRUE, label_size = 1, hjust = 1, 
       size = 2, layout.exp = 10, label_alpha = TRUE)
```

Those with a monthly income less than about $8334 seem unable to get a loan
larger than $25000. I wonder if prosper loans have made a maximum loan amount 
$25,000 for lower income borrowers?

```{r}
grid.arrange(ggplot(subset(Loans, 
        !is.na(LoanOriginalAmount)
        &!is.na(StatedMonthlyIncome)&StatedMonthlyIncome!=0), 
       aes(x = StatedMonthlyIncome, y=LoanOriginalAmount))+
  geom_point(),
 ggplot(subset(Loans, !is.na(LoanOriginalAmount)&
                 !is.na(StatedMonthlyIncome)&StatedMonthlyIncome!=0), 
       aes(x = StatedMonthlyIncome, y=LoanOriginalAmount))+
  geom_point()+
  scale_x_continuous(limits = c(0,20000)),ncol=2) 

Loans %>%
  filter(LoanOriginalAmount>25000)%>%
  filter(StatedMonthlyIncome<8334)%>%
  arrange(StatedMonthlyIncome) %>%
  select(StatedMonthlyIncome, LoanOriginalAmount)
```

If you look at how much money is estimated to be made on average from a loan, 
borrowers with a C ratings tend to give the largest returns.

```{r}
ggplot(subset(Estimated_Total_Returnincash, 
              !is.na(Total_Estimated_Return_Cash)& 
                AllCreditGrades!="NC" &AllCreditGrades!="NA") , 
       aes(x = AllCreditGrades, y =Total_Estimated_Return_Cash))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1,size=8))

Estimated_Total_Returnincash_sub <- subset(Estimated_Total_Returnincash, 
                                      !is.na(Total_Estimated_Return_Cash)& 
                AllCreditGrades!="NC"&AllCreditGrades!="NA")

tapply(Estimated_Total_Returnincash_sub$Total_Estimated_Return_Cash, Estimated_Total_Returnincash_sub$AllCreditGrades, summary)
```

It seems the highest estimated return in-terms of percent increases as loans 
get higher risk with worst borrower credit rating, which makes sense since APR 
increases as well. This can be seen with a F value of 13792 with an extremely 
low p value between all pairs from an analysis of variance POST HOC test.

```{r}
ggplot(subset(Loans, !is.na(EstimatedReturn)& AllCreditGrades!="NC" 
              & AllCreditGrades!="NA"), aes(x = AllCreditGrades, 
                                            y =EstimatedReturn))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1,size=8))

Loans_sub_Estimated_Return <- subset(Loans, !is.na(EstimatedReturn)&
                                       AllCreditGrades!="NC" 
              & AllCreditGrades!="NA")

tapply(Loans_sub_Estimated_Return$EstimatedReturn, 
       Loans_sub_Estimated_Return$AllCreditGrades, summary)
```

```{r}
Loans_Not_Numeric <- Loans[,sapply(Loans, is.factor)]
fit <- aov(EstimatedReturn ~ AllCreditGrades, data= Loans)
summary(fit)

tuk<- TukeyHSD(fit)
tuk
```


```{r}
Total_Returns_Completed <- Loans %>%
  filter(LoanStatus == "Completed")%>%
  mutate(TotalReturn = LP_CustomerPayments-LoanOriginalAmount)

Total_Returns_Completed_Sum <- Total_Returns_Completed %>%
    summarise(total = sum(TotalReturn))
```

Of loans that are completed and not charged off or defaulted, the most return 
on average actually comes from D Credit-grade grade loans with a mean value of 
$1293.00.

```{r}
grid.arrange(ggplot(subset(Total_Returns_Completed,!is.na(TotalReturn)& 
                AllCreditGrades!="NC" & AllCreditGrades!="NA"), 
       aes(x = AllCreditGrades, y =TotalReturn))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1,size=8)),
  ggplot(subset(Total_Returns_Completed,!is.na(TotalReturn)& 
                AllCreditGrades!="NC" & AllCreditGrades!="NA"), 
       aes(x = AllCreditGrades, y =TotalReturn))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1,size=8))+
  scale_y_continuous(breaks= seq(-2000,4000,200))+
  coord_cartesian(ylim= c(-2000,4000))
  ,ncol=2)
  

Total_Returns_Completed_sub <- subset(Total_Returns_Completed,
                                      !is.na(TotalReturn)& 
                AllCreditGrades!="NC" & AllCreditGrades!="NA")

tapply(Total_Returns_Completed_sub$TotalReturn, 
       Total_Returns_Completed_sub$AllCreditGrades, summary)
```

Seems Charged off loans truly began during the 2008 recession. 

```{r}

ggplot(subset(Loans, !is.na(ClosedDate)), aes(y = ClosedDate, 
                                              x = LoanStatus))+
  geom_violin(  )
```

Seems that people who charge off or default on their loans
have about the same median amount of current credit lines as those who complete 
their loans.

```{r}
ggplot(subset(Loans, !is.na(ClosedDate)&!is.na(CurrentCreditLines)), 
       aes(x = LoanStatus, y =CurrentCreditLines))+
  geom_boxplot()

CurrentCreditLines_sub <- subset(Loans, !is.na(ClosedDate)&
                                   !is.na(CurrentCreditLines))

tapply(CurrentCreditLines_sub$CurrentCreditLines, 
       CurrentCreditLines_sub$LoanStatus, summary)
```

As you credit grade gets better your APR gets lower. This relationship is not 
do to random variance based since these two variables have a F value of 55574
and extremely low p values for all pairs in a POST HOC test. Another important
observation is that even with 
a specific credit
grade there are a wide range of APR possible. Even with an HR credit grade an 
borrower can get an loan APR around 0.00864. 

```{r}
#Create a dataframe with all median, mean and distinct number of APRs grouped 
#by specific Credit Grades
LoansAPRM <- Loans %>%
  group_by(AllCreditGrades) %>%
  filter(!is.na(BorrowerAPR)) %>%
  summarise(median = median(BorrowerAPR),
            mean = mean(BorrowerAPR),
            n = n())

names(LoansAPRM)[names(LoansAPRM)=="AllCreditGrades"] <- "AllCredit_Grades"
LoansAPRM$AllCredit_Grades <- factor(LoansAPRM$AllCredit_Grades, levels = 
                                       c('AA','A','B', 'C', 'D', "E", "HR",
                                         "NA"))

ggplot(subset(Loans, is.finite( BorrowerAPR )&AllCreditGrades!="NC"), 
       aes(x = AllCreditGrades, y = BorrowerAPR))+
  geom_boxplot()

BorrowerAPR_sub <- subset(Loans, is.finite( BorrowerAPR )
                          &AllCreditGrades!="NC")

tapply(BorrowerAPR_sub$BorrowerAPR, BorrowerAPR_sub$AllCreditGrades, summary)
```

```{r}
fit <- aov(BorrowerAPR ~ AllCreditGrades, data= Loans)
summary(fit)

tuk<- TukeyHSD(fit)
tuk
```

I found the median APR for all credit grades except AA increased after 
2009.

```{r}
LoansAPRCreditGrade_Pre2009 <- Loans %>%
  group_by(CreditGrade) %>%
  filter(!is.na(BorrowerAPR)) %>%
  summarise(median_before_2009 = median(BorrowerAPR),
            mean_before_2009 = mean(BorrowerAPR),
            n = n())



LoansAPRProsper_Post2009 <- Loans %>%
  group_by(ProsperRating.Alpha) %>%
  filter(!is.na(BorrowerAPR)) %>%
  summarise(median_after_2009 = median(BorrowerAPR),
            mean_after_2009 = mean(BorrowerAPR),
            n = n())
names(LoansAPRProsper_Post2009)[names(LoansAPRProsper_Post2009)
                                =="ProsperRating.Alpha"] <- "CreditGrade"

Before_and_After_2009_APR <- merge(LoansAPRCreditGrade_Pre2009, 
                                   LoansAPRProsper_Post2009,
                                   by = "CreditGrade")


kable(Before_and_After_2009_APR)

Before_and_After_2009_APR_difference <- 
  Before_and_After_2009_APR %>%
  group_by(CreditGrade) %>%
  summarise(medianAPRDifference =              
  ((median_after_2009-median_before_2009)/median_before_2009)*100,
  meanAPRDifference = 
    ((mean_after_2009-mean_before_2009)/mean_before_2009)*100)

Before_and_After_2009_APR_difference$CreditGrade <- 
  factor(Before_and_After_2009_APR_difference$CreditGrade,
         levels = c('AA','A','B', 'C', 'D', "E", "HR", 'NA'))

ggplot(subset(Before_and_After_2009_APR_difference,
              !is.na(CreditGrade)), aes(x = CreditGrade,
                                        y = (medianAPRDifference)))+
  geom_bar(stat="Identity")
```


If you look closer at the HR loans estimated return, they may have negative 
estimated returns in 2009 and 2010 but in normal economic times they are 
usually the highest estimated return.

```{r}

#Create column of only listing creation years not the entire date
Loans$ListingCreationDateYear <- year(Loans$ListingCreationDate)



ggplot(data= subset(Loans, AllCreditGrades == "HR"&!is.na(EstimatedReturn)), 
       aes(y = EstimatedReturn, x =factor(ListingCreationDateYear), 
           color=AllCreditGrades))+
  geom_boxplot()

EstimatedReturn_HR_sub <- subset(Loans, 
                          AllCreditGrades == "HR"&!is.na(EstimatedReturn))

tapply(EstimatedReturn_HR_sub$EstimatedReturn, 
       EstimatedReturn_HR_sub$ListingCreationDateYear, summary)
```

Charged Off and Defaulted loans tended to have a higher return estimate. Sadly, 
these loans most likely will not get paid off. 

```{r}
ggplot(data =subset(Loans, LoanStatus=="Completed"|LoanStatus=="Defaulted"|
                      LoanStatus=="Chargedoff"&!is.na(EstimatedReturn)), 
       aes(y = EstimatedReturn, x =LoanStatus))+
  geom_boxplot(alpha = .3)+
  guides(colour = guide_legend(override.aes = list(alpha = 1)))

EstimatedReturn_LoanStatus_sub <- 
  subset(Loans, LoanStatus=="Completed"|LoanStatus=="Defaulted"|
                      LoanStatus=="Chargedoff"&!is.na(EstimatedReturn))

tapply(EstimatedReturn_LoanStatus_sub$EstimatedReturn, 
       EstimatedReturn_LoanStatus_sub$LoanStatus, summary)
```

Seems Prosper facilitates mostly debt consolidation loans to c credit grades.


```{r}
ListingCategory.numericCounts <- Loans %>%
            group_by(ListingCategory.numeric, AllCreditGrades)%>%
            select(ListingCategory.numeric, AllCreditGrades)%>%
            summarise(count = n())

ggplot(subset(ListingCategory.numericCounts, !is.na(ListingCategory.numeric)), 
       aes(x = AllCreditGrades, y= ListingCategory.numeric,
       fill=AllCreditGrades))+
  geom_tile(aes(fill = count))+ 
  theme(text = element_text(size = 7))+
  scale_fill_continuous(low="blue", high="orange")


```

The C credit grades seems to be the most prevalent in most states.

```{r}

BorrowerStateCounts <- Loans %>%
            group_by(BorrowerState, AllCreditGrades)%>%
            select(BorrowerState, AllCreditGrades)%>%
            summarise(count = n())



ggplot(subset(BorrowerStateCounts, !is.na(BorrowerState)), 
       aes(x = AllCreditGrades, y= factor(BorrowerState),
       fill=AllCreditGrades))+
  geom_tile(aes(fill = count))+ 
  theme(text = element_text(size = 7))+
  scale_fill_continuous(low="blue", high="orange")
```

Is seems that higher educated borrowers with higher paying jobs tend to have 
higher Credit Grades but still a lot of high paying jobs still have bad 
credit ratings.

```{r}
Loans.AllCreditGradespct <- Loans %>% 
  group_by(AllCreditGrades, Occupation) %>%
  summarise(count=n()) 

Loans.AllCreditGradespctsss <- Loans %>% group_by(Occupation) %>%
  summarise(count_all=n()) 

Loans.AllCreditGradespctAll <- merge(Loans.AllCreditGradespct,
                                     Loans.AllCreditGradespctsss,
                                     by="Occupation" )

Loans.AllCreditGradespctAlls <- Loans.AllCreditGradespctAll %>% 
                                mutate(percent = count/count_all*100)


ggplot(Loans.AllCreditGradespctAlls, aes(x = AllCreditGrades, y = Occupation, 
                                         fill = AllCreditGrades ))+
  geom_tile(aes(fill = percent))+ 
  theme(text = element_text(size = 7))+
  scale_fill_continuous(low="blue", high="orange")
```

Most borrowers are granted a loan if they are employed or full-time employeed.

```{r}
ggplot(Loans, aes(x = EmploymentStatus, y=..count.., fill = AllCreditGrades ))+
  geom_bar(position ='dodge')+
  theme(axis.text.x = element_text(angle = 90, hjust = 1,size=8))+
  scale_fill_brewer() + 
  theme_dark()+
  coord_flip()
```

It would seem higher the borrower's credit grade, the larger their loan amount 
usually. On the other hand, the difference between NC and HR loan amount means 
seems to not to be significant based upon a post hoc variance test. 
It is also very interesting that the loan amount average is identical for AA, A 
and B credit ratings.

```{r}
ggplot(subset(Loans, !is.na(AllCreditGrades)), aes(x = AllCreditGrades, 
                                                   y=LoanOriginalAmount 
                                                  ))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1,size=8))+
  guides(colour = guide_legend(override.aes = list(alpha = 1)))

LoanOriginalAmount_sub <- subset(Loans, !is.na(AllCreditGrades))

tapply(LoanOriginalAmount_sub$LoanOriginalAmount, 
       LoanOriginalAmount_sub$AllCreditGrades, summary)
```

```{r}
fit <- aov(LoanOriginalAmount ~ AllCreditGrades, data= Loans)
summary(fit)

tuk<- TukeyHSD(fit)
tuk
```

It is interesting that Credit Score for Credit Grade HR has two different 
spikes around 500 and 660 for the lower Credit Score Range. Credit Grade D also 
has two peaks around 560 and 660. 

```{r}
ggplot(subset(Loans, !is.na(CreditScoreRangeLower)&
                AllCreditGrades!="NC"&AllCreditGrades!="NA"),
       aes(x = CreditScoreRangeLower, y=..count..,colour= AllCreditGrades))+
  geom_freqpoly(binwidth=20)+
    scale_x_continuous(breaks= seq(0,900,20))+   
  scale_colour_brewer()+
  theme_dark()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust=.5))

```

Homemakers are the most likely to have a DebtToIncomeRatio of over 10-1. Is 
this because it takes a large amount of capital to build a home before being
able to sell it?

```{r}
ggplot(subset(Loans, !is.na(DebtToIncomeRatio)&Occupation!="Other"&
                DebtToIncomeRatio>9&Occupation!="Professional"),
       aes(DebtToIncomeRatio))+
  geom_histogram(binwidth = 1)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1,size=8))+
  scale_x_continuous(breaks= seq(8,11,1), limits = c(9,11))+
  facet_wrap(~Occupation)
```

Although most people receive no recommendations for a loan, those with a lower
DebttoIncome Range have a larger amount of outlier values with high numbers of 
recommendations.

```{r}
grid.arrange(ggplot(subset(Loans, 
                    !is.na(DebtToIncomeRatio)&!is.na(Recommendations)), 
       aes(x = DebtToIncomeRatio, y =Recommendations))+
  geom_point(alpha=.5)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1,size=8)),

ggplot(subset(Loans, !is.na(DebtToIncomeRatio)&!is.na(Recommendations)), 
       aes(x = cut(DebtToIncomeRatio, breaks = seq(0,10, by=.5)), 
           y =Recommendations))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1,size=8)), ncol=2)
```

When a investor loans money to a friend, although counter intuitive, it seems
they were more likely to invest more with a friend with a very lower credit
grade of HR.

```{r}
ggplot(subset(Loans, !is.na(InvestmentFromFriendsAmount)&
                InvestmentFromFriendsAmount!=0&!is.na(AllCreditGrades)),
       aes(x = AllCreditGrades, y =InvestmentFromFriendsAmount))+
  geom_boxplot()+
  scale_y_log10()
```


###Multivariate Plots

Charge-offs happened from people with a small to large number deliquesces 
in the last 7 years meaning number of delinquencies would not be the best 
statistic to tell if someone was not going to pay there loans. 

```{r}
Loans$ClosedDateYear <-format(Loans$ClosedDate, "%Y") 

ggplot(subset(Loans, !is.na(ClosedDate)&!is.na(DelinquenciesLast7Years)), 
       aes(x = factor(ClosedDateYear), 
           y =DelinquenciesLast7Years, 
           fill =LoanStatus))+
  geom_boxplot() + scale_y_log10()
```

```{r}
Listing_Cat_Returns <- Loans %>%
  filter(!is.na(EstimatedReturn))%>%
  group_by(ListingCategory.numeric, AllCreditGrades)%>%
  summarise(mean = mean(EstimatedReturn))

Loans <- Loans %>% mutate(ListingCategory.alpha = ListingCategory.numeric)

a <- c("0",'1','2','3','4','5','6','7','8','9','10','11','12','13','14','15',
       '16','17','18','19','20')

b <- c("Not Available", "Debt Consolidation", 'Home Improvement', "Business", 
       'Personal Loan', 'Student Use', 'Auto', 'Other', 'Baby&Adoption',
       'Boat', 'Cosmetic Procedure', 'Engagement Ring', 'Green Loans', 
       'Household Expenses', 'Large Purchases', 'Medical/Dental', 
       'Motorcycle', 'RV','Taxes', 'Vacation', 'Wedding Loans')

#http://stackoverflow.com/questions/29403080/match-and-replace-multiple-
#strings-in-a-vector-of-text-without-looping-in-r
Loans$ListingCategory.alpha <- Loans$ListingCategory.alpha
for(i in seq_along(a)) 
  Loans$ListingCategory.alpha <- gsub(a[i], b[i], Loans$ListingCategory.alpha,
                                      fixed = TRUE)


```

There is more very low or negative return outliers for High 
Risk loans in Auto, Business, Debt Consolidation, and Home Improvement 
categories. Their is also a very large distribution of Student Use estimated 
returns. 

```{r, fig.width=20, fig.height=20}
ggplot(subset(Loans, !is.na(EstimatedReturn)), 
       aes(y = EstimatedReturn, x =factor(ListingCategory.alpha), 
           fill=AllCreditGrades))+
  geom_boxplot(outlier.shape = NA)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  coord_flip()+   
  scale_fill_brewer(direction = -1) + 
  theme_dark()+
  theme(axis.text=element_text(size=40),
        axis.title=element_text(size=40,face="bold"),
        legend.text=element_text(size=20))

ggplot(subset(Loans, !is.na(EstimatedReturn)&AllCreditGrades=="HR"), 
       aes(y = EstimatedReturn, x =factor(ListingCategory.alpha), 
           fill=AllCreditGrades))+
  geom_boxplot(outlier.shape = NA)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1))+
  coord_flip()+   
  scale_fill_brewer(direction = -1) + 
  theme_dark()+
  theme(axis.text=element_text(size=40),
        axis.title=element_text(size=40,face="bold"),
        legend.text=element_text(size=30))
```

Seems the higher you credit score the more money lost when you do not repay 
your loan. 

```{r}
ggplot(subset(Loans, LP_NetPrincipalLoss!=0), aes(x = StatedMonthlyIncome,
                                                  y=LP_GrossPrincipalLoss, 
                                                  color = AllCreditGrades ))+
  geom_point(alpha=.1)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1,size=8))+
  guides(colour = guide_legend(override.aes = list(alpha = 1)))+
  scale_x_log10()+
  geom_smooth(method=lm,# Add linear regression line 
              se=FALSE)+   
  scale_colour_brewer()+
  theme_dark()
```

As one looks closer at the Estimated Returns, one finds that borrowers with 
lower credit grades have the potential to give higher returns in normal 
prosperous economic times. On the other hand, in bad economic times they also 
have the potential to yield significantly lower to negative returns.

```{r}
ggplot(subset(Loans, AllCreditGrades!="NC"&!is.na(AllCreditGrades)&
                !is.na(EstimatedReturn)&!is.na(ListingCreationDateYear)),
       aes(y = EstimatedReturn, x =factor(ListingCreationDateYear), 
           fill=AllCreditGrades))+
  geom_boxplot()+
  scale_fill_brewer(direction = -1) + 
  theme_dark()
```


It is interesting that if you have over 35 lines of credit your credit score 
seems to be very volatile.

```{r}
Loans_CCLCSRL<-Loans%>%
  filter(!is.na(CreditScoreRangeLower))%>%
  filter(!is.na(CurrentCreditLines))%>%
  group_by(AllCreditGrades, CurrentCreditLines) %>%
  summarise(Median_CreditScoreRangeLower=median(CreditScoreRangeLower),
            Mean_CreditScoreRangeLower=mean(CreditScoreRangeLower),
            n= n())


ggplot(Loans_CCLCSRL, aes(x = CurrentCreditLines, 
                          y=Mean_CreditScoreRangeLower))+
  geom_line(aes(color=AllCreditGrades ))+
  theme(axis.text.x = element_text(angle = 90, hjust = 1,size=8))+
  scale_x_continuous(breaks= seq(0,60,5))+   
  scale_colour_brewer()+
  theme_dark()
```

It makes sense as you get a better credit rating you have less delinquencies 
and a higher number of CurrentCreditLines.

```{r}
ggplot(subset(Loans, !is.na( CurrentCreditLines)&AllCreditGrades!="NC"&
                AllCreditGrades!="NA"&!is.na(CurrentDelinquencies)), 
       aes(x = CurrentCreditLines, y=CurrentDelinquencies))+
  geom_bar(stat="identity")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1,size=8))+
  scale_x_continuous(breaks= seq(0,60,5))+
  facet_wrap(~AllCreditGrades, ncol = 1)

```

It is interesting that the amount of money delinquent at its peek is so similar 
between credit rating A and HR.

```{r}
ggplot(subset(Loans, !is.na( CurrentCreditLines)&AllCreditGrades!="NC"&
                AllCreditGrades!="NA"&!is.na(AmountDelinquent)), 
       aes(x = CurrentCreditLines, y=AmountDelinquent))+
  geom_bar(stat="identity")+
  theme(axis.text.x = element_text(angle = 90, hjust = 1,size=8))+
  scale_x_continuous(breaks= seq(0,60,5))+
  facet_wrap(~AllCreditGrades, ncol = 1)
```

It seems the number of recommendations a borrower received did not play a large
role in the Estimated Return from their loan on average. At the same time it 
seems HR loans were a lot more likely to have negative returns.  

```{r}
ggplot(subset(Loans, !is.na(Recommendations)&!is.na(EstimatedReturn)&
                !is.na(AllCreditGrades)), aes(x = factor(Recommendations),
                                              y =EstimatedReturn,
                                              fill=AllCreditGrades))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1,size=8))+   
  scale_fill_brewer(direction = -1) + 
  theme_dark()
```

## Final Plots and Summary

I found the median APR for all credit grades except AA increased after 
2009. It was especially interesting that the mean APR for a AA credit grade 
borrower after 2009 decreased by about 15% while the APR for an HR credit 
grade borrower increased by over 31%. Could such drastic changes have been 
caused by the huge credit crisis of the 2009 recession? This chart alone shows
me the significance of having a great credit rating!

```{r}
LoansAPRCreditGrade_Pre2009 <- Loans %>%
  group_by(CreditGrade) %>%
  filter(!is.na(BorrowerAPR)) %>%
  summarise(median_before_2009 = median(BorrowerAPR),
            mean_before_2009 = mean(BorrowerAPR),
            n = n())



LoansAPRProsper_Post2009 <- Loans %>%
  group_by(ProsperRating.Alpha) %>%
  filter(!is.na(BorrowerAPR)) %>%
  summarise(median_after_2009 = median(BorrowerAPR),
            mean_after_2009 = mean(BorrowerAPR),
            n = n())
names(LoansAPRProsper_Post2009)[names(LoansAPRProsper_Post2009)
                                =="ProsperRating.Alpha"] <- "CreditGrade"

Before_and_After_2009_APR <- merge(LoansAPRCreditGrade_Pre2009, 
                                   LoansAPRProsper_Post2009,
                                   by = "CreditGrade")


kable(Before_and_After_2009_APR)

Before_and_After_2009_APR_difference <- 
  Before_and_After_2009_APR %>%
  group_by(CreditGrade) %>%
  summarise(medianAPRDifference =              
  ((median_after_2009-median_before_2009)/median_before_2009)*100,
  meanAPRDifference = 
    ((mean_after_2009-mean_before_2009)/mean_before_2009)*100)

Before_and_After_2009_APR_difference$CreditGrade <- 
  factor(Before_and_After_2009_APR_difference$CreditGrade,
         levels = c('AA','A','B', 'C', 'D', "E", "HR", 'NA'))

ggplot(subset(Before_and_After_2009_APR_difference,
              !is.na(CreditGrade)), aes(x = CreditGrade,
                                        y = (medianAPRDifference)))+
  geom_bar(stat="Identity")+
  labs(list(title = "Percent Increase Between APR Before and After 2009",
            x = "Credit Grades", y = "Median APR Percent Increase"))+
  scale_y_continuous(breaks= seq(-10,35,2))
```

As one looks closer at the Estimated Returns, one finds that borrowers with 
lower credit grades have the potential to give higher returns in normal 
prosperous economic times. On the other hand, in bad economic times they also 
have the potential to yield significantly lower to negative returns. It is very 
important for investors to truly understand how difficult it is to get their 
money back at all if someones loan is charged-off.

```{r}
ggplot(subset(Loans, AllCreditGrades!="NC"&!is.na(AllCreditGrades)&
                !is.na(EstimatedReturn)&!is.na(ListingCreationDateYear)),
       aes(y = EstimatedReturn, x =factor(ListingCreationDateYear), 
           fill=AllCreditGrades))+
  geom_boxplot()+
  labs(list(title = 
          "Estimated Return vs. Listing Creation Date Year vs. Credit Grade",
          x = "Listing Creation Date Year", y = "Estimated Return (%)"))+   
  scale_fill_brewer(direction = -1) + 
  theme_dark()
```

I wanted to better understand the shear magnitude of loses from charge-off 
loans since I am guessing many investors who use prosper for loans don't 
really understand the huge risks of specific loans. If you add up all losses
investors made from charge-off loans you find investors lost $20,313,392 
including lining Prospers pockets with $1,159,688. I would make sure to 
think twice before giving someone a loan who has a HR credit grade 
especially since Prosper loans still makes millions if you lose your 
life savings. 

```{r}
Total_Charge_off_losses_vs_Prosper_Profit <- Loans %>%
  filter(LoanStatus=="Chargedoff")%>%
  mutate(All_Prosper_Fees = abs(LP_ServiceFees+LP_CollectionFees))%>%
  mutate(Total_Charge_off_losses =
           LoanOriginalAmount-All_Prosper_Fees-LP_NetPrincipalLoss)%>%
  summarise(Charge_off_losses=sum(Total_Charge_off_losses),
            Prosper_Profits = sum(All_Prosper_Fees))
kable(Total_Charge_off_losses_vs_Prosper_Profit)
```

When a investor loans money to a friend, although counter intuitive, it seems
they were more likely to invest more with a friend with a very lower credit
grade of HR. Could this be since they feel sorry for their friend and loan
them money purely since they think no one else would logically lend them
money? I would love to be able to ask these people why they are loaning 
there friend with an HR rating this money. 

```{r}
ggplot(subset(Loans, !is.na(InvestmentFromFriendsAmount) &
                InvestmentFromFriendsAmount!=0 & !is.na(AllCreditGrades)),
       aes(x = AllCreditGrades, y =InvestmentFromFriendsAmount))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1,size=8))+
  scale_y_continuous(breaks= seq(-10,25000,100))+
  coord_cartesian(ylim=c(-10,2500))+
  labs(list(title = "Amount of $ Invested By Friend vs. Credit Grade",
            x = "Credit Grades", y = "Investment from Friend Amount (USD)"))
```

##Reflections

I wished I could have had been given more background on each of the data set's 
variables. The vagueness of the data set's variables made calculating 
the overall payout of all loans for investors on Prosper very difficult.  
For example, listing number 150265 had a Net Principal 
Loss of $7603.16 on a $20,000 loan but had non-principal recovery payments 
amounting to $21,117.90. How is this possible? 

I would also have loved if the dataset had more data on the investors themselves. How much money 
do these investors make a year and what background do they have in investing? 
Such data could give me a better understanding on whether someone with no investing 
experience can make money investing on prosper loans or is more likely to lose
large quantities of money. 

Finally, I wish I had a way to compare prosper loan statistics to a normal
banks loan statistics. I would love to understand how the lending practices
differed between the two and if these differences changed the overall loan
returns on average. Do banks refuse to lend out money to specific borrowers
while prosper allows such loans since they still make money from facilitating
extremely risky loans?

